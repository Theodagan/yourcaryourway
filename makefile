.PHONY: help init scaffold-backend scaffold-frontend docker-build docker-up docker-down clean logs bootstrap setup-env

# Default package name - can be overridden
PACKAGE_NAME ?= example
BASE_PACKAGE = com.$(PACKAGE_NAME).app

help:
	@echo "Available commands:"
	@echo "  make bootstrap PACKAGE_NAME=mycompany  - Complete setup with custom package name"
	@echo "  make init PACKAGE_NAME=mycompany       - Initialize project with custom package name"
	@echo "  make setup-env                         - Create .env file from .env.example"
	@echo "  make scaffold-backend                  - Create Spring Boot backend structure"
	@echo "  make scaffold-frontend                 - Create Angular frontend structure"
	@echo "  make docker-build                      - Build all Docker images"
	@echo "  make docker-up                         - Start all services"
	@echo "  make docker-down                       - Stop all services"
	@echo "  make clean                             - Remove generated files and containers"
	@echo "  make logs                              - Show logs from all containers"
	@echo ""
	@echo "Default package name is 'example'. Override with PACKAGE_NAME=yourname"

bootstrap: setup-env init docker-build docker-up
	@echo ""
	@echo "Project is ready!"
	@echo "================================"
	@echo "Frontend: http://localhost:4200"
	@echo "Backend:  http://localhost:8080"
	@echo "MySQL:    localhost:3306"
	@echo "================================"
	@echo "Run 'make logs' to view container logs"
	@echo ""
	@echo "IMPORTANT: Review and update .env file with your own values!"

setup-env:
	@if [ ! -f .env ]; then \
		if [ -f .env.example ]; then \
			cp .env.example .env; \
			echo ".env file created from .env.example"; \
			echo "Please review and update the values in .env file"; \
		else \
			echo "Creating .env.example and .env files..."; \
			$(MAKE) -s create-env-example; \
			cp .env.example .env; \
			echo ".env file created. Please review and update the values."; \
		fi \
	else \
		echo ".env file already exists, skipping..."; \
	fi

create-env-example:
	@printf '# Database Configuration\nMYSQL_ROOT_PASSWORD=rootpassword\nMYSQL_DATABASE=appdb\nMYSQL_USER=appuser\nMYSQL_PASSWORD=apppassword\nMYSQL_PORT=3306\n\n# Backend Configuration\nBACKEND_PORT=8080\nSPRING_PROFILES_ACTIVE=dev\nSPRING_JPA_HIBERNATE_DDL_AUTO=create\n\n# JWT Configuration\n# Generate a new secret with: openssl rand -base64 64\nJWT_SECRET=404E635266556A586E3272357538782F413F4428472B4B6250645367566B5970\nJWT_EXPIRATION=86400000\n\n# Frontend Configuration\nFRONTEND_PORT=4200\n\n# Adminer\nADMINER_PORT=8081\n\n# CORS Configuration\nCORS_ALLOWED_ORIGINS=http://localhost:4200' > .env.example
	@echo ".env.example created"

init: scaffold-backend scaffold-frontend
	@echo "Project initialized successfully!"
	@echo "Package: $(BASE_PACKAGE)"
	@echo "Run 'make docker-up' to start the application"

scaffold-backend:
	@echo "Creating Spring Boot backend with package: $(BASE_PACKAGE)..."
	@mkdir -p backend/src/main/java/com/$(PACKAGE_NAME)/app
	@mkdir -p backend/src/main/java/com/$(PACKAGE_NAME)/app/common/config
	@mkdir -p backend/src/main/java/com/$(PACKAGE_NAME)/app/common/exception
	@mkdir -p backend/src/main/java/com/$(PACKAGE_NAME)/app/auth/controller
	@mkdir -p backend/src/main/java/com/$(PACKAGE_NAME)/app/auth/dto
	@mkdir -p backend/src/main/java/com/$(PACKAGE_NAME)/app/auth/model
	@mkdir -p backend/src/main/java/com/$(PACKAGE_NAME)/app/auth/repository
	@mkdir -p backend/src/main/java/com/$(PACKAGE_NAME)/app/auth/service
	@mkdir -p backend/src/main/java/com/$(PACKAGE_NAME)/app/auth/security
	@mkdir -p backend/src/main/resources
	@mkdir -p backend/src/test/java/com/$(PACKAGE_NAME)/app
	@$(MAKE) -s create-backend-files
	@$(MAKE) -s create-auth-module
	@echo "Backend scaffolded with modular monolith structure"


scaffold-frontend:
	@echo "Creating Angular frontend..."
	@if ! command -v ng &> /dev/null; then \
		echo "Angular CLI not found. Installing globally..."; \
		npm install -g @angular/cli --save-dev; \
	fi
	@if [ -d "frontend" ]; then \
		echo "Frontend directory already exists, skipping ng new..."; \
	else \
		ng new frontend --routing --style=css --skip-git; \
	fi
	@$(MAKE) -s create-frontend-files
	@$(MAKE) -s create-angular-auth
	@echo "Frontend scaffolded with auth module"


create-backend-files:
	@printf 'FROM maven:3.9-eclipse-temurin-21 as build\nWORKDIR /app\nCOPY pom.xml .\nRUN mvn dependency:go-offline -B\nCOPY src ./src\nRUN mvn clean package -DskipTests -B\n\nFROM eclipse-temurin:21-jre\nWORKDIR /app\nCOPY --from=build /app/target/*.jar app.jar\nEXPOSE 8080\nENTRYPOINT ["java", "-jar", "app.jar"]' > backend/Dockerfile
	@printf '<?xml version="1.0" encoding="UTF-8"?>\n<project xmlns="http://maven.apache.org/POM/4.0.0"\n         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"\n         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0\n         https://maven.apache.org/xsd/maven-4.0.0.xsd">\n    <modelVersion>4.0.0</modelVersion>\n    <parent>\n        <groupId>org.springframework.boot</groupId>\n        <artifactId>spring-boot-starter-parent</artifactId>\n        <version>3.2.0</version>\n    </parent>\n    <groupId>com.$(PACKAGE_NAME)</groupId>\n    <artifactId>app</artifactId>\n    <version>0.0.1-SNAPSHOT</version>\n    <properties>\n        <java.version>21</java.version>\n    </properties>\n    <dependencies>\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-web</artifactId>\n        </dependency>\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-data-jpa</artifactId>\n        </dependency>\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-security</artifactId>\n        </dependency>\n        <dependency>\n            <groupId>io.jsonwebtoken</groupId>\n            <artifactId>jjwt-api</artifactId>\n            <version>0.12.3</version>\n        </dependency>\n        <dependency>\n            <groupId>io.jsonwebtoken</groupId>\n            <artifactId>jjwt-impl</artifactId>\n            <version>0.12.3</version>\n            <scope>runtime</scope>\n        </dependency>\n        <dependency>\n            <groupId>io.jsonwebtoken</groupId>\n            <artifactId>jjwt-jackson</artifactId>\n            <version>0.12.3</version>\n            <scope>runtime</scope>\n        </dependency>\n        <dependency>\n            <groupId>com.mysql</groupId>\n            <artifactId>mysql-connector-j</artifactId>\n        </dependency>\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-validation</artifactId>\n        </dependency>\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-test</artifactId>\n            <scope>test</scope>\n        </dependency>\n    </dependencies>\n    <build>\n        <plugins>\n            <plugin>\n                <groupId>org.springframework.boot</groupId>\n                <artifactId>spring-boot-maven-plugin</artifactId>\n            </plugin>\n        </plugins>\n    </build>\n</project>' > backend/pom.xml
	@printf 'spring.application.name=app\nspring.datasource.url=jdbc:mysql://mysql:$${MYSQL_PORT}/$${MYSQL_DATABASE}\nspring.datasource.username=$${MYSQL_USER}\nspring.datasource.password=$${MYSQL_PASSWORD}\nspring.jpa.hibernate.ddl-auto=update\nspring.sql.init.mode=never\nspring.jpa.defer-datasource-initialization=true\nspring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQL8Dialect\nspring.jpa.show-sql=true\nlogging.level.org.springframework.web=DEBUG\nlogging.level.org.springframework.security=DEBUG\n\n# JWT Configuration\napp.jwt.secret=$${JWT_SECRET}\napp.jwt.expiration=$${JWT_EXPIRATION}' > backend/src/main/resources/application.properties
	@printf 'package $(BASE_PACKAGE);\n\nimport org.springframework.boot.SpringApplication;\nimport org.springframework.boot.autoconfigure.SpringBootApplication;\n\n@SpringBootApplication\npublic class Application {\n    public static void main(String[] args) {\n        SpringApplication.run(Application.class, args);\n    }\n}' > backend/src/main/java/com/$(PACKAGE_NAME)/app/Application.java


create-auth-module:
	@printf 'package $(BASE_PACKAGE).auth.model;\n\nimport jakarta.persistence.*;\nimport java.util.HashSet;\nimport java.util.Set;\n\n@Entity\n@Table(name = "users")\npublic class User {\n    @Id\n    @GeneratedValue(strategy = GenerationType.IDENTITY)\n    private Long id;\n    \n    @Column(unique = true, nullable = false)\n    private String username;\n    \n    @Column(unique = true, nullable = false)\n    private String email;\n    \n    @Column(nullable = false)\n    private String password;\n    \n    @ElementCollection(fetch = FetchType.EAGER)\n    @CollectionTable(name = "user_roles", joinColumns = @JoinColumn(name = "user_id"))\n    @Column(name = "role")\n    private Set<String> roles = new HashSet<>();\n    \n    public User() {}\n    \n    public User(String username, String email, String password) {\n        this.username = username;\n        this.email = email;\n        this.password = password;\n    }\n    \n    public Long getId() { return id; }\n    public void setId(Long id) { this.id = id; }\n    \n    public String getUsername() { return username; }\n    public void setUsername(String username) { this.username = username; }\n    \n    public String getEmail() { return email; }\n    public void setEmail(String email) { this.email = email; }\n    \n    public String getPassword() { return password; }\n    public void setPassword(String password) { this.password = password; }\n    \n    public Set<String> getRoles() { return roles; }\n    public void setRoles(Set<String> roles) { this.roles = roles; }\n}' > backend/src/main/java/com/$(PACKAGE_NAME)/app/auth/model/User.java
	@printf 'package $(BASE_PACKAGE).auth.repository;\n\nimport $(BASE_PACKAGE).auth.model.User;\nimport org.springframework.data.jpa.repository.JpaRepository;\nimport org.springframework.stereotype.Repository;\nimport java.util.Optional;\n\n@Repository\npublic interface UserRepository extends JpaRepository<User, Long> {\n    Optional<User> findByUsername(String username);\n    Optional<User> findByEmail(String email);\n    Boolean existsByUsername(String username);\n    Boolean existsByEmail(String email);\n}' > backend/src/main/java/com/$(PACKAGE_NAME)/app/auth/repository/UserRepository.java
	@printf 'package $(BASE_PACKAGE).auth.dto;\n\nimport jakarta.validation.constraints.*;\n\npublic class LoginRequest {\n    @NotBlank\n    private String username;\n    \n    @NotBlank\n    private String password;\n    \n    public String getUsername() { return username; }\n    public void setUsername(String username) { this.username = username; }\n    \n    public String getPassword() { return password; }\n    public void setPassword(String password) { this.password = password; }\n}' > backend/src/main/java/com/$(PACKAGE_NAME)/app/auth/dto/LoginRequest.java
	@printf 'package $(BASE_PACKAGE).auth.dto;\n\nimport jakarta.validation.constraints.*;\n\npublic class RegisterRequest {\n    @NotBlank\n    @Size(min = 3, max = 20)\n    private String username;\n    \n    @NotBlank\n    @Email\n    private String email;\n    \n    @NotBlank\n    @Size(min = 6, max = 40)\n    private String password;\n    \n    public String getUsername() { return username; }\n    public void setUsername(String username) { this.username = username; }\n    \n    public String getEmail() { return email; }\n    public void setEmail(String email) { this.email = email; }\n    \n    public String getPassword() { return password; }\n    public void setPassword(String password) { this.password = password; }\n}' > backend/src/main/java/com/$(PACKAGE_NAME)/app/auth/dto/RegisterRequest.java
	@printf 'package $(BASE_PACKAGE).auth.dto;\n\npublic class JwtResponse {\n    private String token;\n    private String type = "Bearer";\n    private String username;\n    private String email;\n    \n    public JwtResponse(String token, String username, String email) {\n        this.token = token;\n        this.username = username;\n        this.email = email;\n    }\n    \n    public String getToken() { return token; }\n    public void setToken(String token) { this.token = token; }\n    \n    public String getType() { return type; }\n    public void setType(String type) { this.type = type; }\n    \n    public String getUsername() { return username; }\n    public void setUsername(String username) { this.username = username; }\n    \n    public String getEmail() { return email; }\n    public void setEmail(String email) { this.email = email; }\n}' > backend/src/main/java/com/$(PACKAGE_NAME)/app/auth/dto/JwtResponse.java
	@printf 'package $(BASE_PACKAGE).auth.security;\n\nimport io.jsonwebtoken.*;\nimport io.jsonwebtoken.security.Keys;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.security.core.Authentication;\nimport org.springframework.security.core.userdetails.UserDetails;\nimport org.springframework.stereotype.Component;\nimport javax.crypto.SecretKey;\nimport java.util.Date;\n\n@Component\npublic class JwtTokenProvider {\n    @Value("$${app.jwt.secret}")\n    private String jwtSecret;\n    \n    @Value("$${app.jwt.expiration}")\n    private long jwtExpiration;\n    \n    public String generateToken(Authentication authentication) {\n        UserDetails userPrincipal = (UserDetails) authentication.getPrincipal();\n        Date now = new Date();\n        Date expiryDate = new Date(now.getTime() + jwtExpiration);\n        \n        SecretKey key = Keys.hmacShaKeyFor(jwtSecret.getBytes());\n        \n        return Jwts.builder()\n                .subject(userPrincipal.getUsername())\n                .issuedAt(now)\n                .expiration(expiryDate)\n                .signWith(key)\n                .compact();\n    }\n    \n    public String getUsernameFromToken(String token) {\n        SecretKey key = Keys.hmacShaKeyFor(jwtSecret.getBytes());\n        return Jwts.parser()\n                .verifyWith(key)\n                .build()\n                .parseSignedClaims(token)\n                .getPayload()\n                .getSubject();\n    }\n    \n    public boolean validateToken(String token) {\n        try {\n            SecretKey key = Keys.hmacShaKeyFor(jwtSecret.getBytes());\n            Jwts.parser().verifyWith(key).build().parseSignedClaims(token);\n            return true;\n        } catch (JwtException | IllegalArgumentException e) {\n            return false;\n        }\n    }\n}' > backend/src/main/java/com/$(PACKAGE_NAME)/app/auth/security/JwtTokenProvider.java
	@printf 'package $(BASE_PACKAGE).auth.security;\n\nimport jakarta.servlet.FilterChain;\nimport jakarta.servlet.ServletException;\nimport jakarta.servlet.http.HttpServletRequest;\nimport jakarta.servlet.http.HttpServletResponse;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.security.authentication.UsernamePasswordAuthenticationToken;\nimport org.springframework.security.core.context.SecurityContextHolder;\nimport org.springframework.security.core.userdetails.UserDetails;\nimport org.springframework.security.web.authentication.WebAuthenticationDetailsSource;\nimport org.springframework.stereotype.Component;\nimport org.springframework.util.StringUtils;\nimport org.springframework.web.filter.OncePerRequestFilter;\nimport $(BASE_PACKAGE).auth.service.CustomUserDetailsService;\nimport java.io.IOException;\n\n@Component\npublic class JwtAuthenticationFilter extends OncePerRequestFilter {\n    @Autowired\n    private JwtTokenProvider tokenProvider;\n    \n    @Autowired\n    private CustomUserDetailsService userDetailsService;\n    \n    @Override\n    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)\n            throws ServletException, IOException {\n        try {\n            String jwt = getJwtFromRequest(request);\n            \n            if (StringUtils.hasText(jwt) && tokenProvider.validateToken(jwt)) {\n                String username = tokenProvider.getUsernameFromToken(jwt);\n                UserDetails userDetails = userDetailsService.loadUserByUsername(username);\n                UsernamePasswordAuthenticationToken authentication = \n                    new UsernamePasswordAuthenticationToken(userDetails, null, userDetails.getAuthorities());\n                authentication.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));\n                SecurityContextHolder.getContext().setAuthentication(authentication);\n            }\n        } catch (Exception ex) {\n            logger.error("Could not set user authentication in security context", ex);\n        }\n        \n        filterChain.doFilter(request, response);\n    }\n    \n    private String getJwtFromRequest(HttpServletRequest request) {\n        String bearerToken = request.getHeader("Authorization");\n        if (StringUtils.hasText(bearerToken) && bearerToken.startsWith("Bearer ")) {\n            return bearerToken.substring(7);\n        }\n        return null;\n    }\n}' > backend/src/main/java/com/$(PACKAGE_NAME)/app/auth/security/JwtAuthenticationFilter.java
	@printf 'package $(BASE_PACKAGE).auth.service;\n\nimport $(BASE_PACKAGE).auth.model.User;\nimport $(BASE_PACKAGE).auth.repository.UserRepository;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.security.core.GrantedAuthority;\nimport org.springframework.security.core.authority.SimpleGrantedAuthority;\nimport org.springframework.security.core.userdetails.UserDetails;\nimport org.springframework.security.core.userdetails.UserDetailsService;\nimport org.springframework.security.core.userdetails.UsernameNotFoundException;\nimport org.springframework.stereotype.Service;\nimport java.util.Set;\nimport java.util.stream.Collectors;\n\n@Service\npublic class CustomUserDetailsService implements UserDetailsService {\n    @Autowired\n    private UserRepository userRepository;\n    \n    @Override\n    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {\n        User user = userRepository.findByUsername(username)\n                .orElseThrow(() -> new UsernameNotFoundException("User not found: " + username));\n        \n        Set<GrantedAuthority> authorities = user.getRoles().stream()\n                .map(SimpleGrantedAuthority::new)\n                .collect(Collectors.toSet());\n        \n        return new org.springframework.security.core.userdetails.User(\n                user.getUsername(),\n                user.getPassword(),\n                authorities\n        );\n    }\n}' > backend/src/main/java/com/$(PACKAGE_NAME)/app/auth/service/CustomUserDetailsService.java
	@printf 'package $(BASE_PACKAGE).common.config;\n\nimport $(BASE_PACKAGE).auth.security.JwtAuthenticationFilter;\nimport $(BASE_PACKAGE).auth.service.CustomUserDetailsService;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.security.authentication.AuthenticationManager;\nimport org.springframework.security.authentication.dao.DaoAuthenticationProvider;\nimport org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;\nimport org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;\nimport org.springframework.security.config.annotation.web.builders.HttpSecurity;\nimport org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;\nimport org.springframework.security.config.http.SessionCreationPolicy;\nimport org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;\nimport org.springframework.security.crypto.password.PasswordEncoder;\nimport org.springframework.security.web.SecurityFilterChain;\nimport org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;\nimport org.springframework.web.cors.CorsConfiguration;\nimport org.springframework.web.cors.CorsConfigurationSource;\nimport org.springframework.web.cors.UrlBasedCorsConfigurationSource;\nimport java.util.Arrays;\n\n@Configuration\n@EnableWebSecurity\n@EnableMethodSecurity\npublic class SecurityConfig {\n    @Autowired\n    private CustomUserDetailsService userDetailsService;\n    \n    @Autowired\n    private JwtAuthenticationFilter jwtAuthFilter;\n    \n    @Bean\n    public PasswordEncoder passwordEncoder() {\n        return new BCryptPasswordEncoder();\n    }\n    \n    @Bean\n    public DaoAuthenticationProvider authenticationProvider() {\n        DaoAuthenticationProvider authProvider = new DaoAuthenticationProvider();\n        authProvider.setUserDetailsService(userDetailsService);\n        authProvider.setPasswordEncoder(passwordEncoder());\n        return authProvider;\n    }\n    \n    @Bean\n    public AuthenticationManager authenticationManager(AuthenticationConfiguration config) throws Exception {\n        return config.getAuthenticationManager();\n    }\n    \n    @Bean\n    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {\n        http\n            .csrf(csrf -> csrf.disable())\n            .cors(cors -> cors.configurationSource(corsConfigurationSource()))\n            .sessionManagement(session -> session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))\n            .authorizeHttpRequests(auth -> auth\n                .requestMatchers("/api/auth/**", "/api/public/**").permitAll()\n                .anyRequest().authenticated()\n            )\n            .authenticationProvider(authenticationProvider())\n            .addFilterBefore(jwtAuthFilter, UsernamePasswordAuthenticationFilter.class);\n        \n        return http.build();\n    }\n    \n    @Bean\n    public CorsConfigurationSource corsConfigurationSource() {\n        CorsConfiguration configuration = new CorsConfiguration();\n        configuration.setAllowedOrigins(Arrays.asList("http://localhost:4200"));\n        configuration.setAllowedMethods(Arrays.asList("GET", "POST", "PUT", "DELETE", "OPTIONS"));\n        configuration.setAllowedHeaders(Arrays.asList("*"));\n        configuration.setAllowCredentials(true);\n        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();\n        source.registerCorsConfiguration("/**", configuration);\n        return source;\n    }\n}' > backend/src/main/java/com/$(PACKAGE_NAME)/app/common/config/SecurityConfig.java
	@printf 'package $(BASE_PACKAGE).auth.controller;\n\nimport $(BASE_PACKAGE).auth.dto.*;\nimport $(BASE_PACKAGE).auth.model.User;\nimport $(BASE_PACKAGE).auth.repository.UserRepository;\nimport $(BASE_PACKAGE).auth.security.JwtTokenProvider;\nimport jakarta.validation.Valid;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.http.ResponseEntity;\nimport org.springframework.security.authentication.AuthenticationManager;\nimport org.springframework.security.authentication.UsernamePasswordAuthenticationToken;\nimport org.springframework.security.core.Authentication;\nimport org.springframework.security.core.context.SecurityContextHolder;\nimport org.springframework.security.crypto.password.PasswordEncoder;\nimport org.springframework.web.bind.annotation.*;\nimport java.util.HashSet;\nimport java.util.Set;\n\n@RestController\n@RequestMapping("/api/auth")\npublic class AuthController {\n    @Autowired\n    private AuthenticationManager authenticationManager;\n    \n    @Autowired\n    private UserRepository userRepository;\n    \n    @Autowired\n    private PasswordEncoder passwordEncoder;\n    \n    @Autowired\n    private JwtTokenProvider tokenProvider;\n    \n    @PostMapping("/register")\n    public ResponseEntity<?> registerUser(@Valid @RequestBody RegisterRequest request) {\n        if (userRepository.existsByUsername(request.getUsername())) {\n            return ResponseEntity.badRequest().body("Username is already taken!");\n        }\n        \n        if (userRepository.existsByEmail(request.getEmail())) {\n            return ResponseEntity.badRequest().body("Email is already in use!");\n        }\n        \n        User user = new User(request.getUsername(), request.getEmail(), \n                           passwordEncoder.encode(request.getPassword()));\n        \n        Set<String> roles = new HashSet<>();\n        roles.add("ROLE_USER");\n        user.setRoles(roles);\n        \n        userRepository.save(user);\n        \n        return ResponseEntity.ok("User registered successfully!");\n    }\n    \n    @PostMapping("/login")\n    public ResponseEntity<?> authenticateUser(@Valid @RequestBody LoginRequest request) {\n        Authentication authentication = authenticationManager.authenticate(\n            new UsernamePasswordAuthenticationToken(request.getUsername(), request.getPassword())\n        );\n        \n        SecurityContextHolder.getContext().setAuthentication(authentication);\n        String jwt = tokenProvider.generateToken(authentication);\n        \n        User user = userRepository.findByUsername(request.getUsername()).orElseThrow();\n        \n        return ResponseEntity.ok(new JwtResponse(jwt, user.getUsername(), user.getEmail()));\n    }\n}' > backend/src/main/java/com/$(PACKAGE_NAME)/app/auth/controller/AuthController.java

create-frontend-files:
	@echo 'FROM node:20\nWORKDIR /app\nCOPY package*.json ./\nRUN npm install\nCOPY . .\nEXPOSE 4200\nCMD ["npx", "ng", "serve", "--host", "0.0.0.0", "--proxy-config", "proxy.conf.json"]' > frontend/Dockerfile
	@if [ ! -f frontend/proxy.conf.json ]; then \
		printf '{\n  "/api/**": {\n    "target": "http://backend:8080",\n    "secure": false,\n    "changeOrigin": true\n  }\n}' > frontend/proxy.conf.json; \
	fi
	@if [ -f frontend/package.json ]; then \
		sed -i.bak 's/"start": "ng serve"/"start": "ng serve --proxy-config proxy.conf.json"/' frontend/package.json && rm -f frontend/package.json.bak; \
	fi
	@if [ -f frontend/angular.json ]; then \
		sed -i.bak '/"serve"[[:space:]]*:[[:space:]]*{/,/}/ s/"options"[[:space:]]*:{/"options": {\n        "host": "0.0.0.0",\n        "proxyConfig": "proxy.conf.json",/' frontend/angular.json && rm -f frontend/angular.json.bak; \
	fi


create-angular-auth:
	@echo "Creating Angular auth module..."
	@docker run --rm -v $$(PWD)/frontend:/app -w /app node:20 sh -c "\
		cd src/app && \
		npx -y @angular/cli generate service auth/auth-service --skip-tests && \
		npx -y @angular/cli generate guard auth/auth --skip-tests && \
		npx -y @angular/cli generate component auth/login --skip-tests && \
		npx -y @angular/cli generate component auth/register --skip-tests && \
		npx -y @angular/cli generate interceptor auth/auth --skip-tests"
	@printf "export interface LoginRequest {\n  username: string;\n  password: string;\n}\n\nexport interface RegisterRequest {\n  username: string;\n  email: string;\n  password: string;\n}\n\nexport interface JwtResponse {\n  token: string;\n  type: string;\n  username: string;\n  email: string;\n}\n\nexport interface User {\n  username: string;\n  email: string;\n  token: string;\n}" > frontend/src/app/auth/auth.models.ts
	@printf "import { Injectable } from '@angular/core';\nimport { HttpClient } from '@angular/common/http';\nimport { BehaviorSubject, Observable, tap } from 'rxjs';\nimport { LoginRequest, RegisterRequest, JwtResponse, User } from './auth.models';\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class AuthService {\n  private currentUserSubject: BehaviorSubject<User | null>;\n  public currentUser: Observable<User | null>;\n  private apiUrl = '/api/auth';\n\n  constructor(private http: HttpClient) {\n    const storedUser = localStorage.getItem('currentUser');\n    this.currentUserSubject = new BehaviorSubject<User | null>(\n      storedUser ? JSON.parse(storedUser) : null\n    );\n    this.currentUser = this.currentUserSubject.asObservable();\n  }\n\n  public get currentUserValue(): User | null {\n    return this.currentUserSubject.value;\n  }\n\n  login(credentials: LoginRequest): Observable<JwtResponse> {\n    return this.http.post<JwtResponse>(\`\$${this.apiUrl}/login\`, credentials)\n      .pipe(\n        tap(response => {\n          const user: User = {\n            username: response.username,\n            email: response.email,\n            token: response.token\n          };\n          localStorage.setItem('currentUser', JSON.stringify(user));\n          this.currentUserSubject.next(user);\n        })\n      );\n  }\n\n  register(data: RegisterRequest): Observable<any> {\n    return this.http.post(\`\$${this.apiUrl}/register\`, data);\n  }\n\n  logout(): void {\n    localStorage.removeItem('currentUser');\n    this.currentUserSubject.next(null);\n  }\n\n  isAuthenticated(): boolean {\n    return !!this.currentUserValue;\n  }\n\n  getToken(): string | null {\n    return this.currentUserValue?.token || null;\n  }\n}" > frontend/src/app/auth/auth-service.ts
	@printf "import { inject } from '@angular/core';\nimport { Router, CanActivateFn } from '@angular/router';\nimport { AuthService } from './auth-service';\n\nexport const authGuard: CanActivateFn = (route, state) => {\n  const authService = inject(AuthService);\n  const router = inject(Router);\n\n  if (authService.isAuthenticated()) {\n    return true;\n  }\n\n  router.navigate(['/login'], { queryParams: { returnUrl: state.url } });\n  return false;\n};" > frontend/src/app/auth/auth-guard.ts
	@printf "import { HttpInterceptorFn } from '@angular/common/http';\nimport { inject } from '@angular/core';\nimport { AuthService } from './auth-service';\n\nexport const authInterceptor: HttpInterceptorFn = (req, next) => {\n  const authService = inject(AuthService);\n  const token = authService.getToken();\n\n  if (token) {\n    req = req.clone({\n      setHeaders: {\n        Authorization: \`Bearer $${token}\`\n      }\n    });\n  }\n\n  return next(req);\n};" > frontend/src/app/auth/auth-interceptor.ts
	@printf "import { Component } from '@angular/core';\nimport { CommonModule } from '@angular/common';\nimport { FormBuilder, FormGroup, Validators, ReactiveFormsModule } from '@angular/forms';\nimport { Router, RouterModule } from '@angular/router';\nimport { AuthService } from '../auth-service';\n\n@Component({\n  selector: 'app-login',\n  standalone: true,\n  imports: [CommonModule, ReactiveFormsModule, RouterModule],\n  templateUrl: './login.html',\n  styleUrls: ['./login.css']\n})\nexport class LoginComponent {\n  loginForm: FormGroup;\n  loading = false;\n  errorMessage = '';\n\n  constructor(\n    private fb: FormBuilder,\n    private authService: AuthService,\n    private router: Router\n  ) {\n    this.loginForm = this.fb.group({\n      username: ['', Validators.required],\n      password: ['', Validators.required]\n    });\n  }\n\n  get username() { return this.loginForm.get('username'); }\n  get password() { return this.loginForm.get('password'); }\n\n  onSubmit(): void {\n    if (this.loginForm.invalid) {\n      return;\n    }\n\n    this.loading = true;\n    this.errorMessage = '';\n\n    this.authService.login(this.loginForm.value).subscribe({\n      next: () => {\n        this.router.navigate(['/']);\n      },\n      error: (error) => {\n        this.errorMessage = error.error?.message || 'Invalid username or password';\n        this.loading = false;\n      }\n    });\n  }\n}" > frontend/src/app/auth/login/login.ts
	@printf "<div class=\"login-container\">\n  <div class=\"login-card\">\n    <h2>Login</h2>\n    <form [formGroup]=\"loginForm\" (ngSubmit)=\"onSubmit()\">\n      <div class=\"form-group\">\n        <label for=\"username\">Username</label>\n        <input\n          id=\"username\"\n          type=\"text\"\n          formControlName=\"username\"\n          class=\"form-control\"\n          [class.is-invalid]=\"username?.invalid && username?.touched\"\n        />\n        @if (username?.invalid && username?.touched) {\n          <div class=\"invalid-feedback\">\n            @if (username?.errors?.['required']) {\n              <div>Username is required</div>\n            }\n          </div>\n        }\n      </div>\n\n      <div class=\"form-group\">\n        <label for=\"password\">Password</label>\n        <input\n          id=\"password\"\n          type=\"password\"\n          formControlName=\"password\"\n          class=\"form-control\"\n          [class.is-invalid]=\"password?.invalid && password?.touched\"\n        />\n        @if (password?.invalid && password?.touched) {\n          <div class=\"invalid-feedback\">\n            @if (password?.errors?.['required']) {\n              <div>Password is required</div>\n            }\n          </div>\n        }\n      </div>\n\n      @if (errorMessage) {\n        <div class=\"error-message\">\n          {{ errorMessage }}\n        </div>\n      }\n\n      <button type=\"submit\" class=\"btn btn-primary\" [disabled]=\"loginForm.invalid || loading\">\n        {{ loading ? 'Loading...' : 'Login' }}\n      </button>\n    </form>\n\n    <div class=\"register-link\">\n      No account? <a routerLink=\"/register\">Register here</a>\n    </div>\n  </div>\n</div>\n" > frontend/src/app/auth/login/login.html
	@printf ".login-container {\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  min-height: 100vh;\n  background: linear-gradient(135deg, #667eea 0%%, #764ba2 100%%);\n}\n\n.login-card {\n  background: white;\n  padding: 2rem;\n  border-radius: 10px;\n  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);\n  width: 100%%;\n  max-width: 400px;\n}\n\nh2 {\n  text-align: center;\n  color: #333;\n  margin-bottom: 2rem;\n}\n\n.form-group {\n  margin-bottom: 1.5rem;\n}\n\nlabel {\n  display: block;\n  margin-bottom: 0.5rem;\n  color: #555;\n  font-weight: 500;\n}\n\n.form-control {\n  width: 100%%;\n  padding: 0.75rem;\n  border: 1px solid #ddd;\n  border-radius: 5px;\n  font-size: 1rem;\n  transition: border-color 0.3s;\n}\n\n.form-control:focus {\n  outline: none;\n  border-color: #667eea;\n}\n\n.form-control.is-invalid {\n  border-color: #dc3545;\n}\n\n.invalid-feedback {\n  color: #dc3545;\n  font-size: 0.875rem;\n  margin-top: 0.25rem;\n}\n\n.error-message {\n  background-color: #f8d7da;\n  color: #721c24;\n  padding: 0.75rem;\n  border-radius: 5px;\n  margin-bottom: 1rem;\n  border: 1px solid #f5c6cb;\n}\n\n.btn {\n  width: 100%%;\n  padding: 0.75rem;\n  border: none;\n  border-radius: 5px;\n  font-size: 1rem;\n  font-weight: 600;\n  cursor: pointer;\n  transition: background-color 0.3s;\n}\n\n.btn-primary {\n  background: linear-gradient(135deg, #667eea 0%%, #764ba2 100%%);\n  color: white;\n}\n\n.btn-primary:hover:not(:disabled) {\n  opacity: 0.9;\n}\n\n.btn:disabled {\n  opacity: 0.6;\n  cursor: not-allowed;\n}\n\n.register-link {\n  text-align: center;\n  margin-top: 1.5rem;\n  color: #666;\n}\n\n.register-link a {\n  color: #667eea;\n  text-decoration: none;\n  font-weight: 600;\n}\n\n.register-link a:hover {\n  text-decoration: underline;\n}\n" > frontend/src/app/auth/login/login.css
	@printf "import { Component } from '@angular/core';\nimport { CommonModule } from '@angular/common';\nimport { FormBuilder, FormGroup, Validators, ReactiveFormsModule } from '@angular/forms';\nimport { Router, RouterModule } from '@angular/router';\nimport { AuthService } from '../auth-service';\n\n@Component({\n  selector: 'app-register',\n  standalone: true,\n  imports: [CommonModule, ReactiveFormsModule, RouterModule],\n  templateUrl: './register.html',\n  styleUrls: ['./register.css']\n})\nexport class RegisterComponent {\n  registerForm: FormGroup;\n  loading = false;\n  errorMessage = '';\n  successMessage = '';\n\n  constructor(\n    private fb: FormBuilder,\n    private authService: AuthService,\n    private router: Router\n  ) {\n    this.registerForm = this.fb.group({\n      username: ['', [Validators.required, Validators.minLength(3)]],\n      email: ['', [Validators.required, Validators.email]],\n      password: ['', [Validators.required, Validators.minLength(6)]]\n    });\n  }\n\n  get username() { return this.registerForm.get('username'); }\n  get email() { return this.registerForm.get('email'); }\n  get password() { return this.registerForm.get('password'); }\n\n  onSubmit(): void {\n    if (this.registerForm.invalid) {\n      return;\n    }\n\n    this.loading = true;\n    this.errorMessage = '';\n    this.successMessage = '';\n\n    this.authService.register(this.registerForm.value).subscribe({\n      next: () => {\n        this.successMessage = 'Registration successful! Redirecting to login...';\n        setTimeout(() => {\n          this.router.navigate(['/login']);\n        }, 2000);\n      },\n      error: (error) => {\n        this.errorMessage = error.error || 'Registration failed. Please try again.';\n        this.loading = false;\n      }\n    });\n  }\n}" > frontend/src/app/auth/register/register.ts
	@printf "<div class=\"register-container\">\n  <div class=\"register-card\">\n    <h2>Register</h2>\n    <form [formGroup]=\"registerForm\" (ngSubmit)=\"onSubmit()\">\n      <div class=\"form-group\">\n        <label for=\"username\">Username</label>\n        <input\n          id=\"username\"\n          type=\"text\"\n          formControlName=\"username\"\n          class=\"form-control\"\n          [class.is-invalid]=\"username?.invalid && username?.touched\"\n        />\n        @if (username?.invalid && username?.touched) {\n          <div class=\"invalid-feedback\">\n            @if (username?.errors?.['required']) {\n              <div>Username is required</div>\n            }\n            @if (username?.errors?.['minlength']) {\n              <div>Username must be at least 3 characters</div>\n            }\n          </div>\n        }\n      </div>\n\n      <div class=\"form-group\">\n        <label for=\"email\">Email</label>\n        <input\n          id=\"email\"\n          type=\"email\"\n          formControlName=\"email\"\n          class=\"form-control\"\n          [class.is-invalid]=\"email?.invalid && email?.touched\"\n        />\n        @if (email?.invalid && email?.touched) {\n          <div class=\"invalid-feedback\">\n            @if (email?.errors?.['required']) {\n              <div>Email is required</div>\n            }\n            @if (email?.errors?.['email']) {\n              <div>Invalid email format</div>\n            }\n          </div>\n        }\n      </div>\n\n      <div class=\"form-group\">\n        <label for=\"password\">Password</label>\n        <input\n          id=\"password\"\n          type=\"password\"\n          formControlName=\"password\"\n          class=\"form-control\"\n          [class.is-invalid]=\"password?.invalid && password?.touched\"\n        />\n        @if (password?.invalid && password?.touched) {\n          <div class=\"invalid-feedback\">\n            @if (password?.errors?.['required']) {\n              <div>Password is required</div>\n            }\n            @if (password?.errors?.['minlength']) {\n              <div>Password must be at least 6 characters</div>\n            }\n          </div>\n        }\n      </div>\n\n      @if (successMessage) {\n        <div class=\"success-message\">\n          {{ successMessage }}\n        </div>\n      }\n\n      @if (errorMessage) {\n        <div class=\"error-message\">\n          {{ errorMessage }}\n        </div>\n      }\n\n      <button type=\"submit\" class=\"btn btn-primary\" [disabled]=\"registerForm.invalid || loading\">\n        {{ loading ? 'Loading...' : 'Register' }}\n      </button>\n    </form>\n\n    <div class=\"login-link\">\n      Already have an account? <a routerLink=\"/login\">Login here</a>\n    </div>\n  </div>\n</div>\n" > frontend/src/app/auth/register/register.html
	@printf ".register-container {\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  min-height: 100vh;\n  background: linear-gradient(135deg, #667eea 0%%, #764ba2 100%%);\n}\n\n.register-card {\n  background: white;\n  padding: 2rem;\n  border-radius: 10px;\n  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);\n  width: 100%%;\n  max-width: 400px;\n}\n\nh2 {\n  text-align: center;\n  color: #333;\n  margin-bottom: 2rem;\n}\n\n.form-group {\n  margin-bottom: 1.5rem;\n}\n\nlabel {\n  display: block;\n  margin-bottom: 0.5rem;\n  color: #555;\n  font-weight: 500;\n}\n\n.form-control {\n  width: 100%%;\n  padding: 0.75rem;\n  border: 1px solid #ddd;\n  border-radius: 5px;\n  font-size: 1rem;\n  transition: border-color 0.3s;\n}\n\n.form-control:focus {\n  outline: none;\n  border-color: #667eea;\n}\n\n.form-control.is-invalid {\n  border-color: #dc3545;\n}\n\n.invalid-feedback {\n  color: #dc3545;\n  font-size: 0.875rem;\n  margin-top: 0.25rem;\n}\n\n.error-message {\n  background-color: #f8d7da;\n  color: #721c24;\n  padding: 0.75rem;\n  border-radius: 5px;\n  margin-bottom: 1rem;\n  border: 1px solid #f5c6cb;\n}\n\n.success-message {\n  background-color: #d4edda;\n  color: #155724;\n  padding: 0.75rem;\n  border-radius: 5px;\n  margin-bottom: 1rem;\n  border: 1px solid #c3e6cb;\n}\n\n.btn {\n  width: 100%%;\n  padding: 0.75rem;\n  border: none;\n  border-radius: 5px;\n  font-size: 1rem;\n  font-weight: 600;\n  cursor: pointer;\n  transition: background-color 0.3s;\n}\n\n.btn-primary {\n  background: linear-gradient(135deg, #667eea 0%%, #764ba2 100%%);\n  color: white;\n}\n\n.btn-primary:hover:not(:disabled) {\n  opacity: 0.9;\n}\n\n.btn:disabled {\n  opacity: 0.6;\n  cursor: not-allowed;\n}\n\n.login-link {\n  text-align: center;\n  margin-top: 1.5rem;\n  color: #666;\n}\n\n.login-link a {\n  color: #667eea;\n  text-decoration: none;\n  font-weight: 600;\n}\n\n.login-link a:hover {\n  text-decoration: underline;\n}\n" > frontend/src/app/auth/register/register.css
	@printf "import { Routes } from '@angular/router';\nimport { LoginComponent } from './auth/login/login';\nimport { RegisterComponent } from './auth/register/register';\nimport { authGuard } from './auth/auth-guard';\n\nexport const routes: Routes = [\n  { path: 'login', component: LoginComponent },\n  { path: 'register', component: RegisterComponent },\n  { path: '', redirectTo: '/login', pathMatch: 'full' }\n];" > frontend/src/app/app.routes.ts

docker-build:
	@echo "Building Docker images..."
	docker-compose build

docker-up:
	@echo "Starting services..."
	docker-compose up -d
	@echo "Services started!"
	@echo "Frontend: http://localhost:4200"
	@echo "Backend: http://localhost:8080"
	@echo "MySQL: localhost:3306"

docker-down:
	@echo "Stopping services..."
	docker-compose down

logs:
	docker-compose logs -f

clean:
	@echo "Cleaning up..."
	docker-compose down -v
	rm -rf backend/target
	rm -rf frontend/node_modules
	rm -rf frontend/dist
	@echo "Cleanup complete"
	@echo ""
	@echo "Note: .env file was preserved. To reset it, delete .env and run 'make setup-env'"

sever-git:
	@printf ".env" >> .gitignore
	@set -euo pipefail; \
	BRANCH="${BRANCH:=main}"; \
	MSG="${MSG:=Initial commit}"; \
	CURRENT_DIR="$$(pwd)"; \
	CURRENT_NAME="$$(basename "$$CURRENT_DIR")"; \
	read -p "Enter new app name (leave blank to keep '$$CURRENT_NAME'): " NEW_NAME; \
	if [ -n "$$NEW_NAME" ] && [ "$$NEW_NAME" != "$$CURRENT_NAME" ]; then \
		cd "$$(dirname "$$CURRENT_DIR")"; \
		if [ -e "$$NEW_NAME" ]; then \
		echo "Target folder '$$NEW_NAME' already exists. Aborting rename."; \
		exit 1; \
		fi; \
		mv "$$CURRENT_NAME" "$$NEW_NAME"; \
		cd "$$NEW_NAME"; \
		CURRENT_DIR="$$(pwd)"; \
		echo "Renamed project folder to '$$NEW_NAME'"; \
	fi; \
	cd "$$CURRENT_DIR"; \
	rm -rf .git || true; \
	git init -b "$$BRANCH"; \
	git add -A || true; \
	if git diff --staged --quiet; then \
		echo "Nothing to commit"; \
	else \
		git commit -m "$$MSG"; \
	fi; \
	if [ -n "$(REMOTE)" ]; then git remote add origin "$(REMOTE)"; fi; \
	echo "Repository severed and reinitialized (branch: $$BRANCH)"
